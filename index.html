
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fridge Inventory Tracker – Firebase Edition</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + React‑DOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase v9 compat (gives us the old global `firebase` object so we can use it without a bundler) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Babel for JSX in the browser (dev only) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    // === Firebase bootstrap =========================
    const firebaseConfig = {
      apiKey: "AIzaSyCpbaIxV6nDIose-RdRYeC-3-eH-oIsaRA",
      authDomain: "fridge-tracker-home.firebaseapp.com",
      databaseURL: "https://fridge-tracker-home-default-rtdb.firebaseio.com",
      projectId: "fridge-tracker-home",
      storageBucket: "fridge-tracker-home.appspot.com",   // fixed domain
      messagingSenderId: "580588734189",
      appId: "1:580588734189:web:c8c0c03a0fcc509707aee4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const itemsRef = db.ref('items');

    // === Icons (Lucide – vanilla UMD build) =========
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/lucide@latest';
    script.onload = () => {
      // expose a minimal "LucideReact" shim that returns SVG elements
      window.LucideReact = new Proxy({}, {
        get: (_, icon) => (props) => React.createElement(lucide.createElement, {icon, ...props})
      });
      startApp();
    };
    document.head.appendChild(script);

    // The React app is started only after icons have loaded
    function startApp() {
      const {Plus, Minus, Search, AlertCircle, Clock, Package, Cloud, CloudOff} = window.LucideReact;

      const categories = ['All', 'Dairy', 'Produce', 'Beverages', 'Frozen', 'Pantry', 'Condiments', 'Leftovers'];
      const units = ['pieces', 'kg', 'g', 'litres', 'mL', 'cups', 'bottles', 'cans', 'servings', 'slices', 'carton', 'bags', 'bunches'];

      function FridgeApp() {
        const [currentUser, setCurrentUser] = React.useState(localStorage.getItem('fridgeUser') || '');
        const [showUserModal, setShowUserModal] = React.useState(!currentUser);
        const [items, setItems] = React.useState([]);
        const [searchTerm, setSearchTerm] = React.useState('');
        const [selectedCategory, setSelectedCategory] = React.useState('All');
        const [showAddForm, setShowAddForm] = React.useState(false);
        const [newItem, setNewItem] = React.useState({
          name: '',
          quantity: 1,
          unit: 'pieces',
          category: 'Produce',
          expirationDate: '',
          lowStockThreshold: 1,
        });
        const [connecting, setConnecting] = React.useState(true);

        // ------------- Firebase listeners -------------
        React.useEffect(() => {
          const handle = itemsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const list = Object.entries(data).map(([id, item]) => ({ id, ...item }));
              setItems(list);
            } else {
              setItems([]);
            }
            setConnecting(false);
          });
          return () => itemsRef.off('value', handle);
        }, []);

        // ------------- Helpers ------------------------
        const addItemToDB = (item) => itemsRef.push(item);
        const updateItemInDB = (id, updates) => itemsRef.child(id).update(updates);
        const deleteItemFromDB = (id) => itemsRef.child(id).remove();
        const transactQuantity = (id, delta) => {
          itemsRef.child(id).transaction((item) => {
            if (item) {
              const newQ = Math.max(0, (item.quantity || 0) + delta);
              return {
                ...item,
                quantity: newQ,
                lastUpdatedBy: currentUser,
                lastUpdated: new Date().toISOString(),
              };
            }
            return item;
          });
        };

        // ------------- Computed -----------------------
        const filtered = items.filter((i) => {
          const matchSearch = i.name.toLowerCase().includes(searchTerm.toLowerCase());
          const matchCat = selectedCategory === 'All' || i.category === selectedCategory;
          return matchSearch && matchCat;
        });

        const stats = React.useMemo(() => {
          const lowStock = items.filter((i) => i.quantity <= i.lowStockThreshold).length;
          const expiring = items.filter((i) => daysUntil(i.expirationDate) <= 3).length;
          return { total: items.length, lowStock, expiring };
        }, [items]);

        // ------------- Utility fns --------------------
        const daysUntil = (dateStr) => {
          const today = new Date();
          const exp = new Date(dateStr);
          const diff = exp - today;
          return Math.ceil(diff / (1000 * 60 * 60 * 24));
        };
        const expClass = (dateStr) => {
          const d = daysUntil(dateStr);
          if (d <= 0) return 'bg-red-100 border-red-300';
          if (d <= 3) return 'bg-yellow-100 border-yellow-300';
          return 'bg-white';
        };

        // ------------- UI Components ------------------
        if (showUserModal) {
          return (
            <div className="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 p-4">
              <div className="bg-white rounded-lg p-6 max-w-sm w-full">
                <h2 className="text-2xl font-bold mb-4">Welcome to Fridge Tracker</h2>
                <input
                  className="w-full p-3 border rounded-lg mb-4"
                  placeholder="Enter your name"
                  value={currentUser}
                  onChange={(e) => setCurrentUser(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                />
                <button
                  className="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600"
                  onClick={handleSubmit}
                >Start Tracking</button>
              </div>
            </div>
          );
        }

        function handleSubmit() {
          if (currentUser.trim()) {
            localStorage.setItem('fridgeUser', currentUser.trim());
            setShowUserModal(false);
          }
        }

        const sampleData = () => ({
          OrangeJuice: {
            name: 'Orange Juice',
            quantity: 2,
            unit: 'litres',
            category: 'Beverages',
            expirationDate: new Date(Date.now() + 5 * 864e5).toISOString().split('T')[0],
            lowStockThreshold: 1,
            lastUpdatedBy: 'System',
            lastUpdated: new Date().toISOString(),
          },
          EggWhites: {
            name: 'Egg Whites',
            quantity: 500,
            unit: 'mL',
            category: 'Dairy',
            expirationDate: new Date(Date.now() + 10 * 864e5).toISOString().split('T')[0],
            lowStockThreshold: 100,
            lastUpdatedBy: 'System',
            lastUpdated: new Date().toISOString(),
          },
          Milk: {
            name: 'Milk',
            quantity: 4,
            unit: 'litres',
            category: 'Dairy',
            expirationDate: new Date(Date.now() + 3 * 864e5).toISOString().split('T')[0],
            lowStockThreshold: 1,
            lastUpdatedBy: 'System',
            lastUpdated: new Date().toISOString(),
          },
          Pizza: {
            name: 'Leftover Pizza',
            quantity: 4,
            unit: 'slices',
            category: 'Leftovers',
            expirationDate: new Date(Date.now() + 2 * 864e5).toISOString().split('T')[0],
            lowStockThreshold: 1,
            lastUpdatedBy: 'System',
            lastUpdated: new Date().toISOString(),
          },
        });

        // First‑run seed if DB is empty
        React.useEffect(() => {
          if (!connecting && items.length === 0) {
            itemsRef.set(sampleData());
          }
        }, [connecting]);

        // Add item handler
        const addItem = () => {
          if (newItem.name && newItem.expirationDate) {
            addItemToDB({
              ...newItem,
              lastUpdatedBy: currentUser,
              lastUpdated: new Date().toISOString(),
            });
            setNewItem({ name: '', quantity: 1, unit: 'pieces', category: 'Produce', expirationDate: '', lowStockThreshold: 1 });
            setShowAddForm(false);
          }
        };

        return (
          <div className="min-h-screen flex flex-col">
            {/* Header */}
            <header className="bg-white shadow-sm sticky top-0 z-10 p-4">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-2xl font-bold">Fridge Inventory</h1>
                <div className="text-sm text-gray-600 flex items-center gap-2">
                  {connecting ? (
                    <CloudOff className="w-5 h-5 text-amber-600" title="Connecting…" />
                  ) : (
                    <Cloud className="w-5 h-5 text-emerald-600" title="Connected" />
                  )}
                  <span>User: {currentUser}</span>
                  <button className="text-xs text-blue-500 hover:underline" onClick={() => {
                    localStorage.removeItem('fridgeUser');
                    setShowUserModal(true);
                  }}>change</button>
                </div>
              </div>

              {/* Stats */}
              <div className="grid grid-cols-3 gap-3 mb-4">
                <StatCard icon={<Package className="w-5 h-5 mx-auto" />} label="Total Items" value={stats.total} color="blue" />
                <StatCard icon={<AlertCircle className="w-5 h-5 mx-auto" />} label="Low Stock" value={stats.lowStock} color="yellow" />
                <StatCard icon={<Clock className="w-5 h-5 mx-auto" />} label="Expiring" value={stats.expiring} color="red" />
              </div>

              {/* Search & add */}
              <div className="flex gap-2 mb-4">
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
                  <input className="w-full pl-10 pr-3 py-2 border rounded-lg" placeholder="Search…" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                </div>
                <button className="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2" onClick={() => setShowAddForm(true)}>
                  <Plus className="w-4 h-4" /> Add
                </button>
              </div>

              {/* Categories */}
              <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                {categories.map((c) => (
                  <button key={c} className={`px-3 py-1 rounded-full text-sm whitespace-nowrap ${selectedCategory===c?'bg-blue-500 text-white':'bg-gray-200 text-gray-700'}`} onClick={()=>setSelectedCategory(c)}>{c}</button>
                ))}
              </div>
            </header>

            {/* Item list */}
            <main className="flex-1 p-4">
              {filtered.length===0 ? (
                <div className="text-center py-8 text-gray-500">
                  <Package className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                  {connecting ? 'Connecting to Firebase…' : 'No items found'}
                </div>
              ): (
                filtered.map((item)=>{
                  const low = item.quantity<=item.lowStockThreshold;
                  const d = daysUntil(item.expirationDate);
                  return (
                    <div key={item.id} className={`mb-3 p-4 rounded-lg border ${expClass(item.expirationDate)}`}>
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h3 className="font-semibold text-lg">{item.name}</h3>
                          <div className="text-sm text-gray-600">{item.category} • by {item.lastUpdatedBy}</div>
                        </div>
                        <button className="text-red-500 text-sm" onClick={()=>deleteItemFromDB(item.id)}>Remove</button>
                      </div>
                      <div className="flex justify-between items-center">
                        <div className="flex items-center gap-3">
                          <button className="bg-gray-200 p-2 rounded-lg" onClick={()=>transactQuantity(item.id,-1)}><Minus class="w-4 h-4" /></button>
                          <div className="text-center">
                            <div className="text-xl font-bold">{item.quantity} {item.unit}</div>
                            {low && <div className="text-xs text-red-600">Low Stock!</div>}
                          </div>
                          <button className="bg-gray-200 p-2 rounded-lg" onClick={()=>transactQuantity(item.id,1)}><Plus class="w-4 h-4" /></button>
                        </div>
                        <div className="text-right">
                          <div className="text-sm text-gray-600">Expires in</div>
                          <div className={`${d<=3?'text-red-600':'text-gray-800'} font-semibold`}>{d} days</div>
                        </
