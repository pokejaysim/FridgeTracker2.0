
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge Inventory Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpbaIxV6nDIose-RdRYeC-3-eH-oIsaRA", // Reminder: Secure your Firebase with Security Rules
            authDomain: "fridge-tracker-home.firebaseapp.com",
            databaseURL: "https://fridge-tracker-home-default-rtdb.firebaseio.com",
            projectId: "fridge-tracker-home",
            storageBucket: "fridge-tracker-home.firebasestorage.app",
            messagingSenderId: "580588734189",
            appId: "1:580588734189:web:c8c0c03a0fcc509707aee4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const { useState, useEffect } = React;
        
        // Lucide icons setup - USING LucideReact
        const { Plus, Minus, Search, AlertCircle, Clock, Package, Cloud, CloudOff } = LucideReact; 

        const FridgeInventory = () => {
            const [currentUser, setCurrentUser] = useState('');
            const [showUserModal, setShowUserModal] = useState(true);
            const [items, setItems] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [showAddForm, setShowAddForm] = useState(false);
            const [loading, setLoading] = useState(true); // Initial loading state
            const [connected, setConnected] = useState(true);
            const [newItem, setNewItem] = useState({
                name: '',
                quantity: 1,
                unit: 'pieces',
                category: 'Produce',
                expirationDate: '',
                lowStockThreshold: 1
            });

            const categories = ['All', 'Dairy', 'Produce', 'Beverages', 'Frozen', 'Pantry', 'Condiments', 'Leftovers'];
            const units = ['pieces', 'kg', 'g', 'litres', 'mL', 'cups', 'bottles', 'cans', 'servings', 'slices', 'carton', 'bags', 'bunches'];

            useEffect(() => {
                const savedUser = localStorage.getItem('fridgeTrackerUser');
                if (savedUser) {
                    setCurrentUser(savedUser);
                    setShowUserModal(false);
                } else {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!showUserModal && currentUser) { 
                    setLoading(true); 
                    const connectedRef = database.ref('.info/connected');
                    const onConnectUpdate = connectedRef.on('value', (snap) => {
                        setConnected(snap.val() === true);
                    });

                    const itemsRef = database.ref('items');
                    const onItemsUpdate = itemsRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const itemsList = Object.entries(data).map(([key, value]) => ({
                                ...value,
                                id: key
                            }));
                            setItems(itemsList);
                        } else {
                            setItems([]);
                        }
                        setLoading(false);
                    }, (error) => { 
                        console.error("Firebase items listener error:", error);
                        setLoading(false); 
                    });

                    return () => {
                        connectedRef.off('value', onConnectUpdate);
                        itemsRef.off('value', onItemsUpdate);
                    };
                } else if (!currentUser && !showUserModal) {
                    setItems([]); 
                    setLoading(false);
                }
            }, [showUserModal, currentUser]); 

            const handleUserSubmit = () => {
                if (currentUser.trim()) {
                    localStorage.setItem('fridgeTrackerUser', currentUser.trim()); 
                    setShowUserModal(false);
                }
            };
            
            const handleLogout = () => {
                localStorage.removeItem('fridgeTrackerUser');
                setCurrentUser(''); 
                setShowUserModal(true); 
                setItems([]); 
                setLoading(false); 
            };

            const updateQuantity = async (id, delta) => {
                const item = items.find(item => item.id === id);
                if (item) {
                    const currentQuantity = parseFloat(item.quantity) || 0;
                    const newQuantity = Math.max(0, currentQuantity + delta);
                    database.ref(`items/${id}`).update({
                        quantity: newQuantity,
                        lastUpdatedBy: currentUser,
                        lastUpdated: new Date().toISOString()
                    });
                }
            };

            const addItem = async () => {
                if (newItem.name && newItem.expirationDate) {
                    const itemToAdd = { 
                        ...newItem,
                        quantity: parseFloat(newItem.quantity) || 0,
                        lowStockThreshold: parseFloat(newItem.lowStockThreshold) || 0,
                        lastUpdatedBy: currentUser,
                        lastUpdated: new Date().toISOString()
                    };
                    database.ref('items').push(itemToAdd);
                    setNewItem({ 
                        name: '',
                        quantity: 1,
                        unit: 'pieces',
                        category: 'Produce',
                        expirationDate: '',
                        lowStockThreshold: 1
                    });
                    setShowAddForm(false);
                }
            };

            const deleteItem = async (id) => {
                database.ref(`items/${id}`).remove();
            };

            const getDaysUntilExpiration = (expirationDate) => {
                if (!expirationDate) return 9999; 
                
                const expDateObj = new Date(expirationDate);
                
                if (isNaN(expDateObj.getTime())) {
                    console.warn("Invalid expiration date found:", expirationDate);
                    return 8888; 
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                expDateObj.setHours(0, 0, 0, 0);

                const diffTime = expDateObj.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            const getExpirationClass = (expirationDate) => {
                const days = getDaysUntilExpiration(expirationDate);
                if (days <= 0) return 'bg-red-100 border-red-300';
                if (days <= 3) return 'bg-yellow-100 border-yellow-300';
                if (days === 8888 || days === 9999) return 'bg-gray-100 border-gray-300';
                return 'bg-white border-gray-200';
            };

            const isLowStock = (item) => {
                const quantity = parseFloat(item.quantity) || 0;
                const threshold = parseFloat(item.lowStockThreshold) || 0;
                return quantity > 0 && quantity <= threshold;
            };

            const filteredItems = items.filter(item => {
                const itemName = (item && item.name) ? item.name : "";
                const matchesSearch = itemName.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = selectedCategory === 'All' || item.category === selectedCategory;
                return matchesSearch && matchesCategory;
            }).sort((a, b) => getDaysUntilExpiration(a.expirationDate) - getDaysUntilExpiration(b.expirationDate));

            const getStats = () => {
                const lowStockCount = items.filter(isLowStock).length;
                const expiringCount = items.filter(item => {
                    const days = getDaysUntilExpiration(item.expirationDate);
                    return days >=0 && days <= 3; 
                }).length;
                return { total: items.length, lowStock: lowStockCount, expiring: expiringCount };
            };

            const stats = getStats();

            if (showUserModal) {
                return (
                    <div className="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl">
                            <h2 className="text-2xl font-bold mb-4 text-center">Welcome to Fridge Tracker</h2>
                            <div>
                                <input
                                    type="text"
                                    placeholder="Enter your name"
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500"
                                    value={currentUser}
                                    onChange={(e) => setCurrentUser(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && currentUser.trim() && handleUserSubmit()}
                                    autoFocus
                                />
                                <button
                                    onClick={handleUserSubmit}
                                    disabled={!currentUser.trim()}
                                    className="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 disabled:bg-gray-400"
                                >
                                    Start Tracking
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-700 text-lg">Connecting to Firebase & loading items...</p>
                        </div>
                    </div>
                );
            }

            // Main Application View (Simplified for debugging if needed)
            // To test if the issue is within this block, you can temporarily comment out complex parts
            // and replace with something simple like: <h1>Hello {currentUser}</h1>
            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="p-4 max-w-4xl mx-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-2xl font-bold text-gray-800">Fridge Inventory</h1>
                                <div className="text-right">
                                    <div className="text-sm text-gray-600 flex items-center gap-2 justify-end">
                                        {connected ? (
                                            <Cloud className="w-4 h-4 text-green-500" />
                                        ) : (
                                            <CloudOff className="w-4 h-4 text-red-500" />
                                        )}
                                        <span>User: <span className="font-semibold">{currentUser}</span></span>
                                    </div>
                                    <button 
                                        onClick={handleLogout}
                                        className="text-xs text-blue-500 hover:underline"
                                    >
                                        Change User
                                    </button>
                                </div>
                            </div>

                            {!connected && (
                                <div className="bg-red-100 border border-red-300 rounded-lg p-3 mb-4 text-red-700">
                                    <p className="text-sm flex items-center gap-2"><AlertCircle className="w-4 h-4"/>
                                        <strong>Offline:</strong> Changes will sync when connection is restored.
                                    </p>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                                <div className="bg-blue-100 p-3 rounded-lg text-center shadow">
                                    <Package className="w-5 h-5 mx-auto mb-1 text-blue-600" />
                                    <div className="text-xl font-bold text-blue-800">{stats.total}</div>
                                    <div className="text-xs text-gray-700">Total Items</div>
                                </div>
                                <div className="bg-yellow-100 p-3 rounded-lg text-center shadow">
                                    <AlertCircle className="w-5 h-5 mx-auto mb-1 text-yellow-600" />
                                    <div className="text-xl font-bold text-yellow-800">{stats.lowStock}</div>
                                    <div className="text-xs text-gray-700">Low Stock</div>
                                </div>
                                <div className="bg-red-100 p-3 rounded-lg text-center shadow">
                                    <Clock className="w-5 h-5 mx-auto mb-1 text-red-600" />
                                    <div className="text-xl font-bold text-red-800">{stats.expiring}</div>
                                    <div className="text-xs text-gray-700">Expiring Soon (≤3 days)</div>
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                <div className="relative flex-1">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                                    <input
                                        type="text"
                                        placeholder="Search items..."
                                        className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <button
                                    onClick={() => setShowAddForm(true)}
                                    className="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center justify-center sm:justify-start gap-2 hover:bg-blue-600 font-medium"
                                >
                                    <Plus className="w-4 h-4" />
                                    Add Item
                                </button>
                            </div>

                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                {categories.map(cat => (
                                    <button
                                        key={cat}
                                        onClick={() => setSelectedCategory(cat)}
                                        className={`px-3 py-1 rounded-full text-sm whitespace-nowrap transition-colors ${
                                            selectedCategory === cat
                                                ? 'bg-blue-500 text-white font-semibold'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-4 max-w-4xl mx-auto">
                        {filteredItems.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                <Package className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                                <p className="text-lg">No items found matching your criteria.</p>
                                {items.length === 0 && searchTerm === '' && selectedCategory === 'All' && (
                                     <p className="text-sm mt-1">Add some items to get started!</p>
                                )}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {filteredItems.map(item => {
                                    const daysUntilExpiration = getDaysUntilExpiration(item.expirationDate);
                                    const lowStock = isLowStock(item);
                                    
                                    let expirationText = `Expires in ${daysUntilExpiration} days`;
                                    if (daysUntilExpiration <= 0) expirationText = `Expired ${Math.abs(daysUntilExpiration)} days ago`;
                                    if (daysUntilExpiration === 0) expirationText = 'Expires Today';
                                    if (daysUntilExpiration === 8888 || daysUntilExpiration === 9999) expirationText = "Date Unknown";


                                    return (
                                        <div
                                            key={item.id}
                                            className={`p-4 rounded-lg border shadow-md ${getExpirationClass(item.expirationDate)}`}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1">
                                                    <h3 className="font-semibold text-lg text-gray-800">{item.name || "Unnamed Item"}</h3>
                                                    <div className="text-xs text-gray-500">
                                                        {item.category || "Uncategorized"} • <span className="italic">Updated by {item.lastUpdatedBy || "Unknown"}</span>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => deleteItem(item.id)}
                                                    className="text-red-500 text-sm hover:text-red-700 font-medium p-1"
                                                >
                                                    Remove
                                                </button>
                                            </div>

                                            <div className="flex items-center justify-between my-3">
                                                <div className="flex items-center gap-3">
                                                    <button
                                                        onClick={() => updateQuantity(item.id, -1)}
                                                        disabled={(parseFloat(item.quantity) || 0) <= 0}
                                                        className="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 disabled:opacity-50"
                                                    >
                                                        <Minus className="w-4 h-4" />
                                                    </button>
                                                    <div className="text-center">
                                                        <div className="text-xl font-bold text-gray-700">
                                                            {(parseFloat(item.quantity) || 0)} <span className="text-base font-normal">{item.unit}</span>
                                                        </div>
                                                        {lowStock && (
                                                            <div className="text-xs text-yellow-600 font-semibold">Low Stock!</div>
                                                        )}
                                                        {(parseFloat(item.quantity) || 0) <= 0 && (
                                                            <div className="text-xs text-red-600 font-semibold">Out of Stock!</div>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => updateQuantity(item.id, 1)}
                                                        className="bg-gray-200 p-2 rounded-lg hover:bg-gray-300"
                                                    >
                                                        <Plus className="w-4 h-4" />
                                                    </button>
                                                </div>

                                                <div className="text-right">
                                                    <div className={`text-sm font-medium ${daysUntilExpiration <= 3 ? (daysUntilExpiration <=0 ? 'text-red-600' : 'text-yellow-600') : 'text-gray-700'}`}>
                                                        {expirationText}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="mt-3 flex gap-2 flex-wrap">
                                                <button
                                                    onClick={() => updateQuantity(item.id, -1)}
                                                    disabled={(parseFloat(item.quantity) || 0) <= 0}
                                                    className="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 disabled:opacity-60"
                                                >
                                                    I used 1
                                                </button>
                                                {(parseFloat(item.quantity) || 0) > 1 && (
                                                    <button
                                                        onClick={() => updateQuantity(item.id, -Math.floor((parseFloat(item.quantity) || 0) / 2))}
                                                        className="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200"
                                                    >
                                                        I used half
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })
                            }
                            </div>
                        )}
                    </div>

                    {showAddForm && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-20">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto scrollbar-hide shadow-xl">
                                <h2 className="text-xl font-bold mb-5 text-gray-800">Add New Item</h2>
                                <div>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Item Name*</label>
                                        <input
                                            type="text"
                                            required
                                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"
                                            value={newItem.name}
                                            onChange={(e) => setNewItem({...newItem, name: e.target.value})}
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="any" 
                                                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"
                                                value={newItem.quantity}
                                                onChange={(e) => setNewItem({...newItem, quantity: e.target.value === '' ? '' : parseFloat(e.target.value)})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                                            <select
                                                className="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-1 focus:ring-blue-500"
                                                value={newItem.unit}
                                                onChange={(e) => setNewItem({...newItem, unit: e.target.value})}
                                            >
                                                {units.map(unit => (
                                                    <option key={unit} value={unit}>{unit}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                        <select
                                            className="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-1 focus:ring-blue-500"
                                            value={newItem.category}
                                            onChange={(e) => setNewItem({...newItem, category: e.target.value})}
                                        >
                                            {categories.filter(cat => cat !== 'All').map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Expiration Date*</label>
                                        <input
                                            type="date"
                                            required
                                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"
                                            value={newItem.expirationDate}
                                            min={new Date().toISOString().split('T')[0]}
                                            onChange={(e) => setNewItem({...newItem, expirationDate: e.target.value})}
                                        />
                                    </div>

                                    <div className="mb-5">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Low Stock Alert (when qty ≤)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="any"
                                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"
                                            value={newItem.lowStockThreshold}
                                            onChange={(e) => setNewItem({...newItem, lowStockThreshold: e.target.value === '' ? '' : parseFloat(e.target.value)})}
                                        />
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={addItem}
                                            disabled={!newItem.name.trim() || !newItem.expirationDate}
                                            className="flex-1 bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 disabled:bg-gray-400"
                                        >
                                            Add Item
                                        </button>
                                        <button
                                            onClick={() => setShowAddForm(false)}
                                            className="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Mount the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FridgeInventory />);
    </script>
</body>
</html>