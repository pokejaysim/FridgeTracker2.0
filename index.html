<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge Tracker</title>
    <link rel="manifest" href="data:application/json,{'name':'Fridge Tracker','short_name':'Fridge','start_url':'.','display':'standalone','background_color':'%23f0fdf4','theme_color':'%2316a34a'}">
    <meta name="theme-color" content="#16a34a">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0fdf4; color: #1a1a1a; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }

        /* Header */
        header { background: linear-gradient(135deg, #15803d 0%, #22c55e 100%); color: white; padding: 16px 20px; margin: -16px -16px 20px -16px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 12px rgba(22,163,74,0.3); }
        header h1 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; opacity: 0.9; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #86efac; }
        .sync-dot.syncing { background: #fde047; animation: pulse 1s infinite; }
        .sync-dot.error { background: #fca5a5; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

        /* Household Selector */
        .household-selector { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
        .household-selector:hover { background: rgba(255,255,255,0.3); }
        .household-selector select { background: transparent; border: none; color: white; font-size: 0.9rem; font-weight: 600; cursor: pointer; outline: none; }
        .household-selector select option { color: #1a1a1a; }

        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 12px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .stat-card .icon { font-size: 1.3rem; margin-bottom: 4px; }
        .stat-card .value { font-size: 1.4rem; font-weight: 700; color: #15803d; }
        .stat-card .label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card.warning .value { color: #f59e0b; }
        .stat-card.danger .value { color: #dc2626; }

        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 10px 12px 10px 38px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; transition: border-color 0.2s; }
        .search-box input:focus { outline: none; border-color: #22c55e; }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #94a3b8; }
        .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-primary { background: #22c55e; color: white; }
        .btn-primary:hover { background: #16a34a; }
        .btn-secondary { background: #e2e8f0; color: #475569; }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        .btn-warning { background: #fef3c7; color: #b45309; }
        .btn-warning:hover { background: #fde68a; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* Sort & Filter Bar */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; background: white; border: 2px solid #e2e8f0; cursor: pointer; white-space: nowrap; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .filter-chip:hover { border-color: #22c55e; }
        .filter-chip.active { background: #22c55e; color: white; border-color: #22c55e; }
        .sort-select { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; border: 2px solid #e2e8f0; background: white; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; background: white; padding: 4px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .tab { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .tab:hover { background: #f1f5f9; }
        .tab.active { background: #22c55e; color: white; }
        .tab .badge { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
        .tab.active .badge { background: rgba(255,255,255,0.3); }

        /* Item Cards */
        .items-grid { display: flex; flex-direction: column; gap: 12px; }
        .item-card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #22c55e; transition: all 0.2s; cursor: pointer; }
        .item-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .item-card.expiring-soon { border-left-color: #f59e0b; background: #fffbeb; }
        .item-card.expired { border-left-color: #dc2626; background: #fef2f2; }
        .item-card.low-stock { border-left-color: #f59e0b; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .item-name { font-size: 1.1rem; font-weight: 600; color: #1a1a1a; }
        .item-category { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 6px; display: inline-flex; align-items: center; gap: 4px; }
        .item-meta { display: flex; justify-content: space-between; align-items: center; }
        .item-quantity { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f1f5f9; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .qty-btn:hover { background: #e2e8f0; }
        .qty-btn:active { transform: scale(0.95); }
        .qty-value { font-size: 1.1rem; font-weight: 700; min-width: 60px; text-align: center; }
        .qty-unit { font-size: 0.8rem; color: #64748b; }
        .item-expiry { text-align: right; }
        .expiry-label { font-size: 0.7rem; color: #64748b; }
        .expiry-value { font-size: 0.95rem; font-weight: 600; }
        .expiry-value.warning { color: #f59e0b; }
        .expiry-value.danger { color: #dc2626; }
        .item-actions { display: flex; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f5f9; }
        .item-actions .btn { flex: 1; justify-content: center; }

        /* Shopping List */
        .shopping-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .shopping-item.checked { opacity: 0.5; text-decoration: line-through; }
        .shopping-checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #cbd5e1; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .shopping-checkbox.checked { background: #22c55e; border-color: #22c55e; color: white; }
        .shopping-info { flex: 1; }
        .shopping-name { font-weight: 600; }
        .shopping-reason { font-size: 0.8rem; color: #64748b; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; padding: 16px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #22c55e; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Household Manager */
        .household-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .household-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 10px; }
        .household-item.active { background: #dcfce7; border: 2px solid #22c55e; }
        .household-icon { font-size: 1.5rem; }
        .household-name { flex: 1; font-weight: 600; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        .empty-state .icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: 8px; color: #475569; }

        /* Scanner */
        #scanner-container { position: relative; width: 100%; height: 250px; background: #1a1a1a; border-radius: 12px; overflow: hidden; }
        #scanner-container video { width: 100%; height: 100%; object-fit: cover; }
        .scanner-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
        .scanner-frame { width: 200px; height: 100px; border: 3px solid #22c55e; border-radius: 8px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); }

        /* Responsive */
        @media (max-width: 600px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .controls { flex-direction: column; }
            .search-box { min-width: 100%; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-top">
            <h1>ğŸ§Š Fridge Tracker</h1>
            <div class="header-right">
                <div class="sync-status">
                    <span class="sync-dot" id="sync-dot"></span>
                    <span id="sync-text">Synced</span>
                </div>
                <div class="household-selector" onclick="openHouseholdModal()">
                    <span id="current-household-icon">ğŸ </span>
                    <select id="household-select" onclick="event.stopPropagation()"></select>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card"><div class="icon">ğŸ“¦</div><div class="value" id="stat-total">0</div><div class="label">Items</div></div>
        <div class="stat-card warning"><div class="icon">âš ï¸</div><div class="value" id="stat-low">0</div><div class="label">Low Stock</div></div>
        <div class="stat-card danger"><div class="icon">â°</div><div class="value" id="stat-expiring">0</div><div class="label">Expiring</div></div>
        <div class="stat-card"><div class="icon">ğŸ›’</div><div class="value" id="stat-shopping">0</div><div class="label">To Buy</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="inventory" onclick="switchTab('inventory')">ğŸ“¦ Inventory</button>
        <button class="tab" data-tab="shopping" onclick="switchTab('shopping')">ğŸ›’ Shopping <span class="badge" id="shopping-badge">0</span></button>
    </div>

    <!-- Controls -->
    <div class="controls" id="inventory-controls">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" id="search-input" placeholder="Search items..." oninput="renderItems()">
        </div>
        <button class="btn btn-secondary" onclick="openScannerModal()">ğŸ“· Scan</button>
        <button class="btn btn-primary" onclick="openItemModal()">+ Add Item</button>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar" id="filter-bar"></div>

    <!-- Sort -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-size: 0.85rem; color: #64748b;" id="items-count">0 items</span>
        <select class="sort-select" id="sort-select" onchange="renderItems()">
            <option value="expiry-asc">Expiring Soon</option>
            <option value="name-asc">Name A-Z</option>
            <option value="name-desc">Name Z-A</option>
            <option value="quantity-asc">Quantity Low-High</option>
            <option value="quantity-desc">Quantity High-Low</option>
            <option value="category">Category</option>
        </select>
    </div>

    <!-- Content -->
    <div id="inventory-tab" class="tab-content">
        <div class="items-grid" id="items-grid"></div>
    </div>

    <div id="shopping-tab" class="tab-content" style="display: none;">
        <div id="shopping-list"></div>
        <div style="margin-top: 16px; display: flex; gap: 10px;">
            <button class="btn btn-secondary" style="flex:1;" onclick="clearChecked()">Clear Checked</button>
            <button class="btn btn-primary" style="flex:1;" onclick="exportShoppingList()">ğŸ“‹ Copy List</button>
        </div>
    </div>
</div>

<!-- Item Modal -->
<div class="modal-overlay" id="item-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="item-modal-title">Add Item</h2>
            <button class="modal-close" onclick="closeItemModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="item-id">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="item-name" placeholder="e.g., Milk">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="item-quantity" value="1" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="item-unit">
                        <option value="pcs">pieces</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="L">litres</option>
                        <option value="mL">mL</option>
                        <option value="cups">cups</option>
                        <option value="bottles">bottles</option>
                        <option value="cans">cans</option>
                        <option value="bags">bags</option>
                        <option value="boxes">boxes</option>
                        <option value="cartons">cartons</option>
                        <option value="bunches">bunches</option>
                        <option value="slices">slices</option>
                        <option value="servings">servings</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="item-category">
                    <option value="ğŸ¥¬ Produce">ğŸ¥¬ Produce</option>
                    <option value="ğŸ¥› Dairy">ğŸ¥› Dairy</option>
                    <option value="ğŸ¥© Meat">ğŸ¥© Meat</option>
                    <option value="ğŸ§Š Frozen">ğŸ§Š Frozen</option>
                    <option value="ğŸ¥« Pantry">ğŸ¥« Pantry</option>
                    <option value="ğŸ¥¤ Beverages">ğŸ¥¤ Beverages</option>
                    <option value="ğŸ§‚ Condiments">ğŸ§‚ Condiments</option>
                    <option value="ğŸ± Leftovers">ğŸ± Leftovers</option>
                    <option value="ğŸª Snacks">ğŸª Snacks</option>
                    <option value="ğŸ“¦ Other">ğŸ“¦ Other</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Expiration Date *</label>
                    <input type="date" id="item-expiry">
                </div>
                <div class="form-group">
                    <label>Low Stock Alert</label>
                    <input type="number" id="item-threshold" value="1" min="0" step="0.1">
                </div>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <input type="text" id="item-notes" placeholder="Optional notes...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="delete-item-btn" onclick="deleteItem()" style="display:none; margin-right:auto;">Delete</button>
            <button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveItem()">Save</button>
        </div>
    </div>
</div>

<!-- Household Modal -->
<div class="modal-overlay" id="household-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Manage Households</h2>
            <button class="modal-close" onclick="closeHouseholdModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="household-list" id="household-list"></div>
            <div class="form-group">
                <label>Add New Household</label>
                <div style="display: flex; gap: 8px;">
                    <select id="new-household-icon" style="width: 60px;">
                        <option value="ğŸ ">ğŸ </option>
                        <option value="ğŸ¢">ğŸ¢</option>
                        <option value="ğŸ¡">ğŸ¡</option>
                        <option value="ğŸª">ğŸª</option>
                        <option value="ğŸ¨">ğŸ¨</option>
                        <option value="ğŸ§Š">ğŸ§Š</option>
                    </select>
                    <input type="text" id="new-household-name" placeholder="Household name" style="flex: 1;">
                    <button class="btn btn-primary" onclick="addHousehold()">Add</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="exportData()">ğŸ“¤ Export</button>
            <label class="btn btn-secondary" style="cursor: pointer;">
                ğŸ“¥ Import
                <input type="file" id="import-input" accept=".json" style="display: none;" onchange="importData(event)">
            </label>
            <button class="btn btn-primary" onclick="closeHouseholdModal()">Done</button>
        </div>
    </div>
</div>

<!-- Scanner Modal -->
<div class="modal-overlay" id="scanner-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Scan Barcode</h2>
            <button class="modal-close" onclick="closeScannerModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div id="scanner-container">
                <div class="scanner-overlay"><div class="scanner-frame"></div></div>
            </div>
            <p style="text-align: center; margin-top: 12px; color: #64748b; font-size: 0.85rem;">
                Point camera at barcode Â· Uses Open Food Facts database
            </p>
            <div id="scanner-result" style="text-align: center; margin-top: 12px;"></div>
        </div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- Barcode Scanner -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
    apiKey: "AIzaSyDtU3Vyn54GRCwTUVlRqH6ehVqQ7TUEFqc",
    authDomain: "pjs-apps.firebaseapp.com",
    projectId: "pjs-apps",
    storageBucket: "pjs-apps.firebasestorage.app",
    messagingSenderId: "315953304498",
    appId: "1:315953304498:web:fridge2026"
});
const db = firebase.firestore();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let items = [];
let households = [];
let currentHousehold = localStorage.getItem('fridge_household') || 'home';
let shoppingChecked = JSON.parse(localStorage.getItem('fridge_shopping_checked') || '[]');
let currentCategory = 'All';

const defaultHouseholds = [
    { id: 'home', name: 'Home', icon: 'ğŸ ' },
    { id: 'office', name: 'Office', icon: 'ğŸ¢' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const syncDot = document.getElementById('sync-dot');
const syncText = document.getElementById('sync-text');
function setSynced()  { syncDot.className = 'sync-dot'; syncText.textContent = 'Synced'; }
function setSyncing() { syncDot.className = 'sync-dot syncing'; syncText.textContent = 'Syncing...'; }
function setError()   { syncDot.className = 'sync-dot error'; syncText.textContent = 'Error'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initListeners() {
    // Households
    db.collection('fridge_households').onSnapshot(snap => {
        households = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if (households.length === 0) {
            // Seed defaults
            defaultHouseholds.forEach(h => db.collection('fridge_households').doc(h.id).set({ name: h.name, icon: h.icon }));
            return;
        }
        renderHouseholdSelector();
        setSynced();
    }, err => { console.error(err); setError(); });

    // Items for current household
    db.collection('fridge_items').where('householdId', '==', currentHousehold).onSnapshot(snap => {
        items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderItems();
        updateStats();
        setSynced();
    }, err => { console.error(err); setError(); });
}

function switchHousehold(id) {
    currentHousehold = id;
    localStorage.setItem('fridge_household', id);
    // Re-subscribe to items
    db.collection('fridge_items').where('householdId', '==', currentHousehold).onSnapshot(snap => {
        items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderItems();
        updateStats();
    });
    renderHouseholdSelector();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOUSEHOLDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHouseholdSelector() {
    const select = document.getElementById('household-select');
    const iconEl = document.getElementById('current-household-icon');
    const current = households.find(h => h.id === currentHousehold) || households[0];
    if (current) {
        iconEl.textContent = current.icon;
        currentHousehold = current.id;
    }
    select.innerHTML = households.map(h => 
        `<option value="${h.id}" ${h.id === currentHousehold ? 'selected' : ''}>${h.icon} ${h.name}</option>`
    ).join('');
    select.onchange = () => switchHousehold(select.value);
}

function openHouseholdModal() {
    document.getElementById('household-modal').classList.add('active');
    renderHouseholdList();
}

function closeHouseholdModal() {
    document.getElementById('household-modal').classList.remove('active');
}

function renderHouseholdList() {
    document.getElementById('household-list').innerHTML = households.map(h => `
        <div class="household-item ${h.id === currentHousehold ? 'active' : ''}">
            <span class="household-icon">${h.icon}</span>
            <span class="household-name">${h.name}</span>
            <button class="btn btn-sm btn-secondary" onclick="editHousehold('${h.id}')">Edit</button>
            ${households.length > 1 ? `<button class="btn btn-sm btn-danger" onclick="deleteHousehold('${h.id}')">Ã—</button>` : ''}
        </div>
    `).join('');
}

async function addHousehold() {
    const name = document.getElementById('new-household-name').value.trim();
    const icon = document.getElementById('new-household-icon').value;
    if (!name) return;
    setSyncing();
    await db.collection('fridge_households').add({ name, icon });
    document.getElementById('new-household-name').value = '';
}

async function deleteHousehold(id) {
    if (!confirm('Delete this household and all its items?')) return;
    setSyncing();
    // Delete all items in household
    const snap = await db.collection('fridge_items').where('householdId', '==', id).get();
    const batch = db.batch();
    snap.docs.forEach(d => batch.delete(d.ref));
    batch.delete(db.collection('fridge_households').doc(id));
    await batch.commit();
    if (currentHousehold === id) {
        switchHousehold(households.find(h => h.id !== id)?.id || 'home');
    }
}

function editHousehold(id) {
    const h = households.find(x => x.id === id);
    const newName = prompt('Rename household:', h.name);
    if (newName && newName.trim()) {
        setSyncing();
        db.collection('fridge_households').doc(id).update({ name: newName.trim() });
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDaysUntilExpiry(date) {
    if (!date) return 999;
    const exp = new Date(date + 'T00:00:00');
    const today = new Date();
    today.setHours(0,0,0,0);
    return Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
}

function renderItems() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const sort = document.getElementById('sort-select').value;
    
    let filtered = items.filter(item => {
        const matchSearch = item.name.toLowerCase().includes(search);
        const matchCat = currentCategory === 'All' || item.category === currentCategory;
        return matchSearch && matchCat;
    });

    // Sort
    filtered.sort((a, b) => {
        switch(sort) {
            case 'expiry-asc': return getDaysUntilExpiry(a.expiryDate) - getDaysUntilExpiry(b.expiryDate);
            case 'name-asc': return a.name.localeCompare(b.name);
            case 'name-desc': return b.name.localeCompare(a.name);
            case 'quantity-asc': return a.quantity - b.quantity;
            case 'quantity-desc': return b.quantity - a.quantity;
            case 'category': return (a.category || '').localeCompare(b.category || '');
            default: return 0;
        }
    });

    document.getElementById('items-count').textContent = `${filtered.length} item${filtered.length !== 1 ? 's' : ''}`;

    if (filtered.length === 0) {
        document.getElementById('items-grid').innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ§Š</div>
                <h3>No items found</h3>
                <p>Add items to track your fridge inventory</p>
            </div>`;
        return;
    }

    document.getElementById('items-grid').innerHTML = filtered.map(item => {
        const days = getDaysUntilExpiry(item.expiryDate);
        const isExpired = days <= 0;
        const isExpiring = days > 0 && days <= 3;
        const isLow = item.quantity <= (item.threshold || 1);
        let cardClass = 'item-card';
        if (isExpired) cardClass += ' expired';
        else if (isExpiring) cardClass += ' expiring-soon';
        else if (isLow) cardClass += ' low-stock';

        let expiryText = days <= 0 ? 'Expired!' : days === 1 ? '1 day' : `${days} days`;
        let expiryClass = days <= 0 ? 'danger' : days <= 3 ? 'warning' : '';

        return `
            <div class="${cardClass}" onclick="openItemModal('${item.id}')">
                <div class="item-header">
                    <div>
                        <div class="item-name">${item.name}</div>
                        <span class="item-category">${item.category || 'ğŸ“¦ Other'}</span>
                    </div>
                </div>
                <div class="item-meta">
                    <div class="item-quantity">
                        <button class="qty-btn" onclick="event.stopPropagation(); updateQty('${item.id}', -1)">âˆ’</button>
                        <div>
                            <span class="qty-value">${item.quantity}</span>
                            <span class="qty-unit">${item.unit || 'pcs'}</span>
                        </div>
                        <button class="qty-btn" onclick="event.stopPropagation(); updateQty('${item.id}', 1)">+</button>
                    </div>
                    <div class="item-expiry">
                        <div class="expiry-label">Expires in</div>
                        <div class="expiry-value ${expiryClass}">${expiryText}</div>
                    </div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); updateQty('${item.id}', -1)">Used 1</button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); updateQty('${item.id}', -Math.ceil(${item.quantity}/2))">Used Half</button>
                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); addToShopping('${item.id}')">ğŸ›’ Buy More</button>
                </div>
            </div>
        `;
    }).join('');

    renderFilterBar();
}

function renderFilterBar() {
    const categories = ['All', ...new Set(items.map(i => i.category).filter(Boolean))];
    document.getElementById('filter-bar').innerHTML = categories.map(cat => 
        `<button class="filter-chip ${cat === currentCategory ? 'active' : ''}" onclick="setCategory('${cat}')">${cat}</button>`
    ).join('');
}

function setCategory(cat) {
    currentCategory = cat;
    renderItems();
}

async function updateQty(id, delta) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    const newQty = Math.max(0, item.quantity + delta);
    setSyncing();
    await db.collection('fridge_items').doc(id).update({ 
        quantity: newQty,
        updatedAt: new Date().toISOString()
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openItemModal(id = null) {
    const modal = document.getElementById('item-modal');
    const title = document.getElementById('item-modal-title');
    const deleteBtn = document.getElementById('delete-item-btn');
    
    if (id) {
        const item = items.find(i => i.id === id);
        if (!item) return;
        title.textContent = 'Edit Item';
        deleteBtn.style.display = 'block';
        document.getElementById('item-id').value = id;
        document.getElementById('item-name').value = item.name;
        document.getElementById('item-quantity').value = item.quantity;
        document.getElementById('item-unit').value = item.unit || 'pcs';
        document.getElementById('item-category').value = item.category || 'ğŸ“¦ Other';
        document.getElementById('item-expiry').value = item.expiryDate || '';
        document.getElementById('item-threshold').value = item.threshold || 1;
        document.getElementById('item-notes').value = item.notes || '';
    } else {
        title.textContent = 'Add Item';
        deleteBtn.style.display = 'none';
        document.getElementById('item-id').value = '';
        document.getElementById('item-name').value = '';
        document.getElementById('item-quantity').value = 1;
        document.getElementById('item-unit').value = 'pcs';
        document.getElementById('item-category').value = 'ğŸ¥¬ Produce';
        document.getElementById('item-expiry').value = '';
        document.getElementById('item-threshold').value = 1;
        document.getElementById('item-notes').value = '';
    }
    modal.classList.add('active');
}

function closeItemModal() {
    document.getElementById('item-modal').classList.remove('active');
}

async function saveItem() {
    const id = document.getElementById('item-id').value;
    const name = document.getElementById('item-name').value.trim();
    const expiry = document.getElementById('item-expiry').value;
    
    if (!name || !expiry) {
        alert('Please enter item name and expiration date');
        return;
    }

    const data = {
        name,
        quantity: parseFloat(document.getElementById('item-quantity').value) || 1,
        unit: document.getElementById('item-unit').value,
        category: document.getElementById('item-category').value,
        expiryDate: expiry,
        threshold: parseFloat(document.getElementById('item-threshold').value) || 1,
        notes: document.getElementById('item-notes').value,
        householdId: currentHousehold,
        updatedAt: new Date().toISOString()
    };

    setSyncing();
    if (id) {
        await db.collection('fridge_items').doc(id).update(data);
    } else {
        data.createdAt = new Date().toISOString();
        await db.collection('fridge_items').add(data);
    }
    closeItemModal();
}

async function deleteItem() {
    const id = document.getElementById('item-id').value;
    if (!id || !confirm('Delete this item?')) return;
    setSyncing();
    await db.collection('fridge_items').doc(id).delete();
    closeItemModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
    const total = items.length;
    const low = items.filter(i => i.quantity <= (i.threshold || 1)).length;
    const expiring = items.filter(i => getDaysUntilExpiry(i.expiryDate) <= 3).length;
    const shopping = getShoppingList().length;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-low').textContent = low;
    document.getElementById('stat-expiring').textContent = expiring;
    document.getElementById('stat-shopping').textContent = shopping;
    document.getElementById('shopping-badge').textContent = shopping;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOPPING LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getShoppingList() {
    const lowStock = items.filter(i => i.quantity <= (i.threshold || 1)).map(i => ({
        id: i.id,
        name: i.name,
        reason: 'Low stock',
        checked: shoppingChecked.includes(i.id)
    }));
    const expiringSoon = items.filter(i => getDaysUntilExpiry(i.expiryDate) <= 1 && !lowStock.find(l => l.id === i.id)).map(i => ({
        id: i.id,
        name: i.name,
        reason: 'Expiring soon',
        checked: shoppingChecked.includes(i.id)
    }));
    return [...lowStock, ...expiringSoon];
}

function renderShoppingList() {
    const list = getShoppingList();
    if (list.length === 0) {
        document.getElementById('shopping-list').innerHTML = `
            <div class="empty-state">
                <div class="icon">âœ…</div>
                <h3>All stocked up!</h3>
                <p>No items need restocking</p>
            </div>`;
        return;
    }
    document.getElementById('shopping-list').innerHTML = list.map(item => `
        <div class="shopping-item ${item.checked ? 'checked' : ''}">
            <div class="shopping-checkbox ${item.checked ? 'checked' : ''}" onclick="toggleShoppingItem('${item.id}')">
                ${item.checked ? 'âœ“' : ''}
            </div>
            <div class="shopping-info">
                <div class="shopping-name">${item.name}</div>
                <div class="shopping-reason">${item.reason}</div>
            </div>
        </div>
    `).join('');
}

function toggleShoppingItem(id) {
    if (shoppingChecked.includes(id)) {
        shoppingChecked = shoppingChecked.filter(x => x !== id);
    } else {
        shoppingChecked.push(id);
    }
    localStorage.setItem('fridge_shopping_checked', JSON.stringify(shoppingChecked));
    renderShoppingList();
}

function addToShopping(id) {
    // This just flags item as low stock equivalent - in practice just alert
    alert('Item added to shopping consideration. Lower the quantity or threshold to auto-add to shopping list.');
}

function clearChecked() {
    shoppingChecked = [];
    localStorage.setItem('fridge_shopping_checked', JSON.stringify(shoppingChecked));
    renderShoppingList();
}

function exportShoppingList() {
    const list = getShoppingList().filter(i => !i.checked);
    const text = 'ğŸ›’ Shopping List\n\n' + list.map(i => `â€¢ ${i.name} (${i.reason})`).join('\n');
    navigator.clipboard.writeText(text).then(() => alert('Shopping list copied!'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
    
    document.getElementById('inventory-tab').style.display = tab === 'inventory' ? 'block' : 'none';
    document.getElementById('shopping-tab').style.display = tab === 'shopping' ? 'block' : 'none';
    document.getElementById('inventory-controls').style.display = tab === 'inventory' ? 'flex' : 'none';
    document.getElementById('filter-bar').style.display = tab === 'inventory' ? 'flex' : 'none';
    document.querySelector('[id="sort-select"]').parentElement.style.display = tab === 'inventory' ? 'flex' : 'none';

    if (tab === 'shopping') renderShoppingList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BARCODE SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scannerRunning = false;

function openScannerModal() {
    document.getElementById('scanner-modal').classList.add('active');
    document.getElementById('scanner-result').innerHTML = '';
    startScanner();
}

function closeScannerModal() {
    stopScanner();
    document.getElementById('scanner-modal').classList.remove('active');
}

function startScanner() {
    if (scannerRunning) return;
    scannerRunning = true;
    
    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector('#scanner-container'),
            constraints: { facingMode: "environment", width: 640, height: 480 }
        },
        decoder: {
            readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader", "code_128_reader"]
        },
        locate: true
    }, err => {
        if (err) {
            document.getElementById('scanner-result').innerHTML = '<p style="color:#dc2626;">Camera not available</p>';
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(result => {
        const code = result.codeResult.code;
        stopScanner();
        lookupBarcode(code);
    });
}

function stopScanner() {
    if (scannerRunning) {
        Quagga.stop();
        scannerRunning = false;
    }
}

async function lookupBarcode(code) {
    document.getElementById('scanner-result').innerHTML = '<p>Looking up product...</p>';
    
    try {
        const resp = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
        const data = await resp.json();
        
        closeScannerModal();
        
        if (data.status === 1 && data.product) {
            const p = data.product;
            document.getElementById('item-name').value = p.product_name || `Product ${code}`;
            document.getElementById('item-category').value = guessCategory(p);
            openItemModal();
        } else {
            document.getElementById('item-name').value = `Product ${code}`;
            openItemModal();
        }
    } catch (e) {
        closeScannerModal();
        document.getElementById('item-name').value = `Product ${code}`;
        openItemModal();
    }
}

function guessCategory(product) {
    const tags = (product.categories_tags || []).join(' ').toLowerCase();
    const name = (product.product_name || '').toLowerCase();
    
    if (tags.includes('dairy') || name.includes('milk') || name.includes('cheese') || name.includes('yogurt')) return 'ğŸ¥› Dairy';
    if (tags.includes('beverage') || name.includes('juice') || name.includes('drink') || name.includes('soda')) return 'ğŸ¥¤ Beverages';
    if (tags.includes('frozen')) return 'ğŸ§Š Frozen';
    if (tags.includes('meat') || name.includes('chicken') || name.includes('beef') || name.includes('pork')) return 'ğŸ¥© Meat';
    if (tags.includes('snack') || name.includes('chip') || name.includes('cookie')) return 'ğŸª Snacks';
    if (tags.includes('sauce') || tags.includes('condiment')) return 'ğŸ§‚ Condiments';
    return 'ğŸ¥« Pantry';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
    const data = {
        version: 2,
        exportDate: new Date().toISOString(),
        households,
        items
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fridge-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

async function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (!confirm(`Import ${data.items?.length || 0} items and ${data.households?.length || 0} households?`)) return;
            
            setSyncing();
            const batch = db.batch();
            
            // Import households
            (data.households || []).forEach(h => {
                const ref = db.collection('fridge_households').doc(h.id || db.collection('fridge_households').doc().id);
                batch.set(ref, { name: h.name, icon: h.icon || 'ğŸ ' }, { merge: true });
            });
            
            // Import items
            (data.items || []).forEach(item => {
                const { id, ...rest } = item;
                const ref = db.collection('fridge_items').doc();
                batch.set(ref, { ...rest, importedAt: new Date().toISOString() });
            });
            
            await batch.commit();
            alert('Import complete!');
            closeHouseholdModal();
        } catch (err) {
            alert('Import failed: ' + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initListeners();
</script>
</body>
</html>
