<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fridge Inventory Tracker – Firebase Edition</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>

  <!-- Firebase v9 compat (global `firebase`) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js" defer></script>

  <!-- Lucide (vanilla) -->
  <script src="https://unpkg.com/lucide@latest" defer></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- Main app -->
  <script type="text/babel" data-presets="react">
    // ------------------------------------------------------------
    //  Bootstrap once DOM & all libs are ready
    // ------------------------------------------------------------
    function start() {
      // Guard: lucide might not be ready yet (it runs before us, but just in case)
      if (!window.lucide) {
        setTimeout(start, 50);
        return;
      }

      // --- Icon helpers (wrap raw SVG) --------------------------
      const makeIcon = (name) => (props) => {
        const svg = window.lucide[name]?.toSvg({ class: props.className });
        return <span dangerouslySetInnerHTML={{ __html: svg }} />;
      };
      const Plus = makeIcon('Plus');
      const Minus = makeIcon('Minus');
      const Search = makeIcon('Search');
      const AlertCircle = makeIcon('AlertCircle');
      const Clock = makeIcon('Clock');
      const Package = makeIcon('Package');
      const Cloud = makeIcon('Cloud');
      const CloudOff = makeIcon('CloudOff');

      // --- Firebase init ---------------------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyCpbaIxV6nDIose-RdRYeC-3-eH-oIsaRA",
        authDomain: "fridge-tracker-home.firebaseapp.com",
        databaseURL: "https://fridge-tracker-home-default-rtdb.firebaseio.com",
        projectId: "fridge-tracker-home",
        storageBucket: "fridge-tracker-home.appspot.com",
        messagingSenderId: "580588734189",
        appId: "1:580588734189:web:c8c0c03a0fcc509707aee4",
      };
      firebase.initializeApp(firebaseConfig);
      const itemsRef = firebase.database().ref('items');

      // --- Utility fns -----------------------------------------
      const categories = ['All','Dairy','Produce','Beverages','Frozen','Pantry','Condiments','Leftovers'];
      const units = ['pieces','kg','g','litres','mL','cups','bottles','cans','servings','slices','carton','bags','bunches'];
      const daysUntil = (d) => Math.ceil((new Date(d) - new Date()) / 864e5);
      const expClass = (d) => {
        const x = daysUntil(d);
        return x<=0?'bg-red-100 border-red-300':x<=3?'bg-yellow-100 border-yellow-300':'bg-white';
      };

      const Stat = ({icon,label,val,color}) => (
        <div className={`rounded-lg p-3 text-center bg-${color}-100`}>
          {icon}
          <div className={`text-xl font-bold text-${color}-700`}>{val}</div>
          <div className="text-xs text-gray-700">{label}</div>
        </div>
      );

      // --- Main App component ----------------------------------
      function App(){
        const [user,setUser]=React.useState(localStorage.getItem('fridgeUser')||'');
        const [items,setItems]=React.useState([]);
        const [search,setSearch]=React.useState('');
        const [cat,setCat]=React.useState('All');
        const [showAdd,setShowAdd]=React.useState(false);
        const [draft,setDraft]=React.useState({name:'',quantity:1,unit:'pieces',category:'Produce',expirationDate:'',lowStockThreshold:1});
        const [connecting,setConnecting]=React.useState(true);

        React.useEffect(()=>{
          const h=itemsRef.on('value',s=>{
            const data=s.val();
            setItems(data?Object.entries(data).map(([id,i])=>({id,...i})):[]);
            setConnecting(false);
          });
          return ()=>itemsRef.off('value',h);
        },[]);

        React.useEffect(()=>{
          if(!connecting&&items.length===0){
            itemsRef.set({
              sample:{name:'Orange Juice',quantity:2,unit:'litres',category:'Beverages',expirationDate:new Date(Date.now()+5*864e5).toISOString().split('T')[0],lowStockThreshold:1,lastUpdatedBy:'System',lastUpdated:new Date().toISOString()}
            });
          }
        },[connecting]);

        const submitUser=()=>{if(user.trim()){localStorage.setItem('fridgeUser',user.trim());}};
        const add=()=>{if(draft.name&&draft.expirationDate){itemsRef.push({...draft,lastUpdatedBy:user,lastUpdated:new Date().toISOString()});setDraft({name:'',quantity:1,unit:'pieces',category:'Produce',expirationDate:'',lowStockThreshold:1});setShowAdd(false);}};
        const tx=(id,d)=>itemsRef.child(id).transaction(it=>it?{...it,quantity:Math.max(0,(it.quantity||0)+d),lastUpdatedBy:user,lastUpdated:new Date().toISOString()}:it);
        const del=id=>itemsRef.child(id).remove();

        const list=items.filter(i=>i.name.toLowerCase().includes(search.toLowerCase())&&(cat==='All'||i.category===cat));
        const stats={total:items.length,low:items.filter(i=>i.quantity<=i.lowStockThreshold).length,exp:items.filter(i=>daysUntil(i.expirationDate)<=3).length};

        if(!user) return (
          <div className="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 p-4">
            <div className="bg-white p-6 rounded-lg max-w-sm w-full">
              <h2 className="text-2xl font-bold mb-4">Welcome</h2>
              <input className="w-full border p-3 rounded mb-4" value={user} placeholder="Your name" onChange={e=>setUser(e.target.value)} onKeyDown={e=>e.key==='Enter'&&submitUser()} />
              <button className="w-full bg-blue-500 text-white p-3 rounded" onClick={submitUser}>Enter</button>
            </div>
          </div>
        );

        return (
          <div className="min-h-screen flex flex-col">
            <header className="bg-white shadow-sm sticky top-0 z-10 p-4">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-2xl font-bold">Fridge Inventory</h1>
                <div className="flex items-center gap-2 text-sm text-gray-600">
                  {connecting?<CloudOff className="w-5 h-5 text-amber-600"/>:<Cloud className="w-5 h-5 text-emerald-600"/>}
                  <span>{user}</span>
                  <button className="text-blue-500 text-xs" onClick={()=>{localStorage.removeItem('fridgeUser');setUser('');}}>change</button>
                </div>
              </div>
              <div className="grid grid-cols-3 gap-3 mb-4">
                <Stat icon={<Package className="w-5 h-5 mx-auto"/>} label="Total" val={stats.total} color="blue" />
                <Stat icon={<AlertCircle className="w-5 h-5 mx-auto"/>} label="Low" val={stats.low} color="yellow" />
                <Stat icon={<Clock className="w-5 h-5 mx-auto"/>} label="Exp" val={stats.exp} color="red" />
              </div>
              <div className="flex gap-2 mb-4">
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-3 w-4 h-4 text-gray-400"/>
                  <input className="w-full border rounded pl-10 pr-3 py-2" placeholder="Search…" value={search} onChange={e=>setSearch(e.target.value)} />
                </div>
                <button className="bg-blue-500 text-white px-4 py-2 rounded flex items-center gap-2" onClick={()=>setShowAdd(true)}><Plus className="w-4 h-4"/>Add</button>
              </div>
              <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                {categories.map(c=><button key={c} className={`${cat===c?'bg-blue-500 text-white':'bg-gray-200 text-gray-700'} px-3 py-1 rounded-full text-sm`} onClick={()=>setCat(c)}>{c}</button>)}
              </div>
            </header>

            <main className="flex-1 p-4">
              {list.length===0?(
                <div className="text-center py-8 text-gray-500"><Package className="w-12 h-12 mx-auto mb-3 text-gray-300"/> {connecting?'Connecting…':'No items'}</div>
              ):list.map(it=>{
                const d=daysUntil(it.expirationDate);
                const low=it.quantity<=it.lowStockThreshold;
                return (
                  <div key={it.id} className={`mb-3 p-4 rounded-lg border ${expClass(it.expirationDate)}`}>

